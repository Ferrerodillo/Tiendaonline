<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Tienda de prueba con Mercado Pago</title>
  <script src="https://sdk.mercadopago.com/js/v2"></script>
  <style>
    body { font-family: sans-serif; max-width: 600px; margin: 2rem auto; }
    .producto { border: 1px solid #ccc; padding: 1rem; margin-bottom: 1rem; }
    .total { font-size: 1.2em; font-weight: bold; }
  </style>
</head>
<body>
  <h1>Tienda de Prueba</h1>

  <div class="producto" data-id="1" data-title="Camiseta Blanca" data-price="250">
    <h3>Camiseta Blanca</h3>
    <p>Precio: $250</p>
    <button class="agregar">Agregar al carrito</button>
  </div>

  <div class="producto" data-id="2" data-title="Gorra Negra" data-price="150">
    <h3>Gorra Negra</h3>
    <p>Precio: $150</p>
    <button class="agregar">Agregar al carrito</button>
  </div>

  <p class="total">Total: $<span id="total">0</span></p>

  <!-- Contenedor del botón de Mercado Pago -->
  <div id="wallet_container"></div>

  <script type="module">
    const mp = new window.MercadoPago("APP_USR-0668701b-e33d-4e49-b32c-6cd78586a7ee", {
      locale: "es-MX"
    });

    let carrito = [];
    const totalEl = document.getElementById("total");

    function actualizarTotal() {
      const total = carrito.reduce((acc, item) => acc + item.unit_price * item.quantity, 0);
      totalEl.textContent = total;
    }

    document.querySelectorAll(".agregar").forEach(btn => {
      btn.addEventListener("click", () => {
        const producto = btn.closest(".producto");
        const id = producto.dataset.id;
        const title = producto.dataset.title;
        const price = parseFloat(producto.dataset.price);

        const existente = carrito.find(p => p.id === id);
        if (existente) {
          existente.quantity++;
        } else {
          carrito.push({
            id,
            title,
            unit_price: price,
            quantity: 1,
            currency_id: "MXN"
          });
        }

        actualizarTotal();
      });
    });

    // Crea preferencia y muestra botón
    async function crearBotonPago() {
      if (carrito.length === 0) return alert("Agrega productos al carrito");

      const res = await fetch("https://console.firebase.google.com/project/rodilloback/overview", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ items: carrito })
      });

      const { id: preferenceId } = await res.json();

      const bricksBuilder = await mp.bricks();
      await bricksBuilder.create("wallet", "wallet_container", {
        initialization: { preferenceId }
      });
    }

    // Botón para generar el botón de pago después de agregar productos
    const btnGenerarPago = document.createElement("button");
    btnGenerarPago.textContent = "Pagar con Mercado Pago";
    btnGenerarPago.onclick = crearBotonPago;
    document.body.appendChild(btnGenerarPago);
  </script>
</body>
</html>
