<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Tienda con Mercado Pago</title>
  <script src="https://sdk.mercadopago.com/js/v2"></script>
  <style>
    body { font-family: sans-serif; max-width: 600px; margin: 2rem auto; }
    .producto { border: 1px solid #ccc; padding: 1rem; margin-bottom: 1rem; }
    .total { font-size: 1.2em; font-weight: bold; margin-top: 2rem; }
    button { padding: 0.5rem 1rem; }
  </style>
</head>
<body>
  <h1>Tienda de prueba</h1>

  <!-- Productos -->
  <div class="producto" data-id="1" data-title="Playera Blanca" data-price="250">
    <h3>Playera Blanca</h3>
    <p>Precio: $250</p>
    <button class="agregar">Agregar al carrito</button>
  </div>

  <div class="producto" data-id="2" data-title="Gorra Negra" data-price="150">
    <h3>Gorra Negra</h3>
    <p>Precio: $150</p>
    <button class="agregar">Agregar al carrito</button>
  </div>

  <!-- Total -->
  <p class="total">Total: $<span id="total">0</span></p>

  <!-- Botón para generar preferencia -->
  <button id="btnPagar">Pagar con Mercado Pago</button>

  <!-- Contenedor del botón real de MP -->
  <div id="wallet_container" style="margin-top: 20px;"></div>

  <script type="module">
    const mp = new window.MercadoPago('APP_USR-0668701b-e33d-4e49-b32c-6cd78586a7ee', {
      locale: 'es-MX'
    });

    let carrito = [];
    const totalEl = document.getElementById('total');

    function actualizarTotal() {
      const total = carrito.reduce((acc, item) => acc + item.unit_price * item.quantity, 0);
      totalEl.textContent = total;
    }

    document.querySelectorAll('.agregar').forEach(btn => {
      btn.addEventListener('click', () => {
        const producto = btn.closest('.producto');
        const id = producto.dataset.id;
        const title = producto.dataset.title;
        const price = parseFloat(producto.dataset.price);

        const existente = carrito.find(p => p.id === id);
        if (existente) {
          existente.quantity++;
        } else {
          carrito.push({
            id,
            title,
            unit_price: price,
            quantity: 1,
            currency_id: 'MXN'
          });
        }

        actualizarTotal();
      });
    });

    document.getElementById('btnPagar').addEventListener('click', async () => {
      if (carrito.length === 0) {
        alert('Agrega productos al carrito');
        return;
      }

      // Llamar a tu función de Firebase
const respuesta = await fetch('https://crear-preferencia-lir7xgr7aq-uc.a.run.app', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({ items: carrito })
});

if (!respuesta.ok) {
  const errorData = await respuesta.json();
  console.error('❌ Error desde el backend:', errorData);
  alert('Error al crear preferencia: ' + errorData.error);
  return;
}

const datos = await respuesta.json();
const preferenceId = datos.id;

      const bricksBuilder = await mp.bricks();
      await bricksBuilder.create('wallet', 'wallet_container', {
        initialization: { preferenceId },
        customization: { texts: { valueProp: 'smart_option' } }
      });
    });
  </script>
</body>
</html>
